{
    "sourceFile": "src/pages/VehicleAmcFilter.jsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 1,
            "patches": [
                {
                    "date": 1763039776805,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1763041918363,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -80,16 +80,16 @@\n       navigate(\"/\", { replace: true });\r\n     }\r\n   }, [isLoggedIn, navigate]);\r\n \r\n-  useEffect(() => {\r\n-    document.body.style.overflow = \"auto\";\r\n-    document.documentElement.style.overflow = \"auto\";\r\n-    return () => {\r\n-      document.body.style.overflow = \"auto\";\r\n-      document.documentElement.style.overflow = \"auto\";\r\n-    };\r\n-  }, []);\r\n+  // useEffect(() => {\r\n+  //   document.body.style.overflow = \"auto\";\r\n+  //   document.documentElement.style.overflow = \"auto\";\r\n+  //   return () => {\r\n+  //     document.body.style.overflow = \"auto\";\r\n+  //     document.documentElement.style.overflow = \"auto\";\r\n+  //   };\r\n+  // }, []);\r\n \r\n   useEffect(() => {\r\n     if (status === \"success\" || status === \"failed\") {\r\n       setShowPopup(status);\r\n"
                }
            ],
            "date": 1763039776805,
            "name": "Commit-0",
            "content": "import React, { useState, useEffect, Suspense } from \"react\";\r\nconst AmcTabs = React.lazy(() => import(\"../components/AmcTabs\"));\r\nconst AmcCard = React.lazy(() => import(\"../components/AmcCard\"));\r\nconst CompareTable = React.lazy(() => import(\"../components/CompareTable\"));\r\nconst LatestOffer = React.lazy(() => import(\"../components/LatestOffer\"));\r\nconst AmcBanner = React.lazy(() => import(\"../components/AmcBanner\"));\r\nconst AddBanner = React.lazy(() => import(\"../components/AddBanner\"));\r\nconst PlanSummaryPage = React.lazy(() => import(\"../popup/PlanSummaryPage\"));\r\nconst SuccessPurchase = React.lazy(() => import(\"../popup/SuccessPurchase\"));\r\nconst FailedPurchase = React.lazy(() => import(\"../popup/FailedPurchase\"));\r\nimport { useAuth } from \"../context/AuthContext\";\r\nimport { createAMCPurchase } from \"../api/amcApi\";\r\nimport { useSearchParams, useNavigate, useLocation } from \"react-router-dom\";\r\nimport AMC from \"../components/AMC\";\r\nimport useAmcData from \"../hooks/useAmcData\";\r\n\r\nconst CardLoader = () => (\r\n  <div className=\"h-64 bg-gray-200 animate-pulse rounded-lg\"></div>\r\n);\r\nconst TableLoader = () => (\r\n  <div className=\"h-96 bg-gray-200 animate-pulse rounded-lg\"></div>\r\n);\r\nconst BannerLoader = () => (\r\n  <div className=\"h-48 bg-gray-200 animate-pulse rounded-lg\"></div>\r\n);\r\nconst ComponentLoader = () => (\r\n  <div className=\"flex justify-center items-center py-8\">\r\n    <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-[#266DDF]\"></div>\r\n  </div>\r\n);\r\n\r\nconst VehicleAmcFilter = () => {\r\n  const { isLoggedIn } = useAuth();\r\n  const [searchParams, setSearchParams] = useSearchParams();\r\n  const navigate = useNavigate();\r\n  const location = useLocation();\r\n\r\n  const {\r\n    plans,\r\n    vehicle: locationVehicle,\r\n    selectedPlan: initialSelectedPlan,\r\n  } = location.state || {};\r\n\r\n  const {\r\n    vehicleType,\r\n    setVehicleType,\r\n    amcType,\r\n    setAmcType,\r\n    getAmcTabs,\r\n    comparePlans,\r\n    features,\r\n  } = useAmcData();\r\n\r\n  const [vehicle, setVehicle] = useState(() => {\r\n    const stored = sessionStorage.getItem('failedPaymentData');\r\n    if (stored) {\r\n      const parsed = JSON.parse(stored);\r\n      return parsed.vehicle || locationVehicle;\r\n    }\r\n    return locationVehicle;\r\n  });\r\n\r\n  const [selectedPlanState, setSelectedPlanState] = useState(() => {\r\n    const stored = sessionStorage.getItem('failedPaymentData');\r\n    if (stored) {\r\n      const parsed = JSON.parse(stored);\r\n      return parsed.selectedPlan || null;\r\n    }\r\n    return null;\r\n  });\r\n\r\n  const [isPopupOpen, setIsPopupOpen] = useState(false);\r\n  const [showPopup, setShowPopup] = useState(null);\r\n\r\n  const status = searchParams.get(\"status\");\r\n  const txnid = searchParams.get(\"txnid\");\r\n\r\n  useEffect(() => {\r\n    if (!isLoggedIn) {\r\n      navigate(\"/\", { replace: true });\r\n    }\r\n  }, [isLoggedIn, navigate]);\r\n\r\n  useEffect(() => {\r\n    document.body.style.overflow = \"auto\";\r\n    document.documentElement.style.overflow = \"auto\";\r\n    return () => {\r\n      document.body.style.overflow = \"auto\";\r\n      document.documentElement.style.overflow = \"auto\";\r\n    };\r\n  }, []);\r\n\r\n  useEffect(() => {\r\n    if (status === \"success\" || status === \"failed\") {\r\n      setShowPopup(status);\r\n      \r\n      if (status === \"failed\") {\r\n        const stored = sessionStorage.getItem('failedPaymentData');\r\n        if (stored) {\r\n          const parsed = JSON.parse(stored);\r\n          setVehicle(parsed.vehicle);\r\n          setSelectedPlanState(parsed.selectedPlan);\r\n        }\r\n      }\r\n    }\r\n  }, [status]);\r\n\r\n  useEffect(() => {\r\n    // Restore vehicleType from sessionStorage on page load\r\n    const stored = sessionStorage.getItem('selectedVehicleType');\r\n    if (stored && stored !== vehicleType) {\r\n      setVehicleType(stored);\r\n    }\r\n  }, []);\r\n  \r\n  const handleBuyNow = async (plan) => {\r\n    if (!vehicle?.vehicleNumber) {\r\n      alert(\"Please select a vehicle first.\");\r\n      return;\r\n    }\r\n\r\n    const purchaseResponse = await createAMCPurchase({\r\n      planId: plan._id,\r\n      vehicleNumber: vehicle.vehicleNumber,\r\n    });\r\n\r\n    if (!purchaseResponse.success) {\r\n      alert(purchaseResponse.message || \"Failed to create AMC purchase\");\r\n      return;\r\n    }\r\n\r\n    const purchaseData = purchaseResponse.data;\r\n    const planData = {\r\n      ...plan,\r\n      purchaseId: purchaseData._id,\r\n      vehicleNumber: vehicle.vehicleNumber,\r\n    };\r\n\r\n    sessionStorage.setItem('failedPaymentData', JSON.stringify({\r\n      selectedPlan: planData,\r\n      vehicle: vehicle\r\n    }));\r\n\r\n    setSelectedPlanState(planData);\r\n    setIsPopupOpen(true);\r\n  };\r\n\r\n  const handleClosePopup = () => {\r\n    setSelectedPlanState(null);\r\n    setIsPopupOpen(false);\r\n  };\r\n\r\n  const handleClosePaymentPopup = () => {\r\n    setShowPopup(null);\r\n    searchParams.delete(\"status\");\r\n    searchParams.delete(\"txnid\");\r\n    setSearchParams(searchParams, { replace: true });\r\n  };\r\n\r\n  const handleSuccessClose = () => {\r\n    sessionStorage.removeItem('failedPaymentData');\r\n    setShowPopup(null);\r\n    searchParams.delete(\"status\");\r\n    searchParams.delete(\"txnid\");\r\n    setSearchParams(searchParams, { replace: true });\r\n  };\r\n\r\n  if (!isLoggedIn) {\r\n    return null;\r\n  }\r\n\r\n  return (\r\n    <section className=\"bg-white w-full min-h-screen\">\r\n      <AMC\r\n        vehicleType={vehicleType}\r\n        setVehicleType={setVehicleType}\r\n        isFilter={true}\r\n      />\r\n      <Suspense fallback={<ComponentLoader />}>\r\n        <AmcTabs\r\n          amcType={amcType}\r\n          setAmcType={setAmcType}\r\n          showRemoveFilter\r\n          tabs={getAmcTabs}\r\n          vehicleType={vehicleType}\r\n        />\r\n      </Suspense>\r\n      <Suspense fallback={<CardLoader />}>\r\n        <AmcCard\r\n          vehicleType={vehicleType}\r\n          onBuy={handleBuyNow}\r\n          plans={plans}\r\n          vehicle={vehicle}\r\n        />\r\n      </Suspense>\r\n      <Suspense fallback={<TableLoader />}>\r\n        <CompareTable\r\n          plansAre={plans}\r\n          features={features}\r\n          onBuyNow={handleBuyNow}\r\n          vehicle={vehicle}\r\n        />\r\n      </Suspense>\r\n      {/* <Suspense fallback={<BannerLoader />}>\r\n        <LatestOffer />\r\n      </Suspense>\r\n\r\n      <div className=\"flex flex-col space-y-10\">\r\n        <Suspense fallback={<BannerLoader />}>\r\n          <AmcBanner onBuy={handleBuyNow} />\r\n        </Suspense>\r\n      </div> */}\r\n\r\n      {isPopupOpen && (\r\n        <Suspense fallback={null}>\r\n          <PlanSummaryPage\r\n            isOpen={isPopupOpen}\r\n            plan={selectedPlanState}\r\n            onClose={handleClosePopup}\r\n            vehicle={vehicle}\r\n          />\r\n        </Suspense>\r\n      )}\r\n\r\n      {showPopup === \"success\" && (\r\n        <div className=\"fixed inset-0 backdrop-blur-md bg-opacity-50 flex items-center justify-center z-50\">\r\n          <Suspense fallback={<div className=\"text-white\">Loading...</div>}>\r\n            <SuccessPurchase\r\n              onClose={handleSuccessClose}\r\n              purchaseData={selectedPlanState}\r\n            />\r\n          </Suspense>\r\n        </div>\r\n      )}\r\n\r\n      {showPopup === \"failed\" && (\r\n        <div className=\"fixed inset-0 backdrop-blur-md bg-opacity-50 flex items-center justify-center z-50\">\r\n          <Suspense fallback={<div className=\"text-white\">Loading...</div>}>\r\n            <FailedPurchase\r\n              reason=\"Your UPI payment was not completed or cancelled.\"\r\n              onClose={handleClosePaymentPopup}\r\n              purchaseData={selectedPlanState}\r\n            />\r\n          </Suspense>\r\n        </div>\r\n      )}\r\n    </section>\r\n  );\r\n};\r\n\r\nexport default VehicleAmcFilter;"
        }
    ]
}